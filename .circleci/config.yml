version: 2.1
orbs:
  ionic: okode/ionic@1.0.63
parameters:
  attach-workspace:
    type: boolean
    default: false
  node-version:
    type: string
    default: '14'
  cordova-version:
    type: string
    default: latest
  gradle-version:
    type: string
    default: ''
  dist-certs-repo-url:
    type: string
    default: ''
  ssh-permission-fingerprint:
    type: string
    default: ''
  custom-npm-login:
    type: boolean
    default: false
  pwa-path:
    type: string
    default: www
  api-version:
    description: Deprecated
    type: string
    default: deprecated
executor:
  name: android/android
  sdk-version: '29'
  variant: node
steps:
  - run:
      name: Checking deprecated parameters
      command: |
        if [[ "<< parameters.api-version >>" != "deprecated" ]]; then
          echo "Parameter api-version is deprecated"
        fi
  - checkout
  - run:
      name: Upgrading Node v<< parameters.node-version >>
      command: |
        sudo npm i -g n
        sudo n << parameters.node-version >>
  - when:
      condition: << parameters.custom-npm-login >>
      steps:
        - run:
            name: Logging into custom NPM registry
            command: sudo npm install -g npm-cli-adduser && npm-cli-adduser
  - common/npm-install
  - common/install-android:
      gradle-version: << parameters.gradle-version >>
      cordova-version: << parameters.cordova-version >>
  - when:
      condition: << parameters.attach-workspace >>
      steps:
        - attach_workspace:
            at: .
        - run:
            name: Clearing sourcemaps
            command: find << parameters.pwa-path >> -name *.map -type f -delete
  - common/keystores:
      dist-certs-repo-url: << parameters.dist-certs-repo-url >>
      ssh-permission-fingerprint: << parameters.ssh-permission-fingerprint >>
  - gradle/with_cache:
      steps:
        - run:
            name: Building
            command: |
              if [[ -f "scripts/build.sh" ]]; then
                scripts/build.sh
              else
                npm run ci:build
              fi
            no_output_timeout: 30m
  - persist_to_workspace:
      root: .
      paths:
        - output/*.apk
        - output/*.aab
  - run:
      name: Deploying
      command: |
        if [[ -f "scripts/deploy.sh" ]]; then
          scripts/deploy.sh
        else
          npm run ci:deploy
        fi
      no_output_timeout: 20m